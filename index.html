<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Habit Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #00B22D;
            --primary-dark: #008020;
            --secondary: #FF6B00;
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #666666;
            --danger: #FF3B30;
            --success: #00B22D;
            --warning: #FF9500;
            --card-bg: #FFFFFF;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 24px;
        }

        .logo i {
            color: var(--primary);
            font-size: 28px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            color: var(--gray);
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab:hover:not(.active) {
            background: var(--light);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .habits-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .habits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .habits-header h2 {
            color: var(--dark);
            font-size: 20px;
        }

        .habit-tag {
            background: var(--light);
            color: var(--gray);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .habits-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .habit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--light);
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .habit-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }

        .habit-info {
            flex: 1;
        }

        .habit-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 18px;
        }

        .habit-description {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .habit-actions {
            display: flex;
            gap: 10px;
        }

        .btn-complete {
            background: #e8f5e9;
            color: var(--success);
        }

        .btn-complete.active {
            background: var(--success);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }

        .heatmap-container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 3px;
            margin-top: 15px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            color: var(--gray);
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 1001;
            animation: toastIn 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .heatmap-grid {
                grid-template-columns: repeat(26, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-fire"></i>
                <h1>Habit Tracker</h1>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="openModal()">
                    <i class="fas fa-plus"></i> Novo Hábito
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('today')">Hoje</button>
            <button class="tab" onclick="switchTab('all')">Todos</button>
            <button class="tab" onclick="switchTab('stats')">Estatísticas</button>
        </div>

        <!-- Today Tab -->
        <div id="todayTab" class="tab-content">
            <div class="habits-section">
                <div class="habits-header">
                    <h2>Hábitos de Hoje</h2>
                    <div class="habit-tag">0 de 0 concluídos</div>
                </div>
                <div class="habits-list" id="todayHabitsList">
                    <!-- Hábitos de hoje serão renderizados aqui -->
                </div>
            </div>
        </div>

        <!-- All Habits Tab -->
        <div id="allTab" class="tab-content" style="display: none;">
            <div class="habits-section">
                <div class="habits-header">
                    <h2>Todos os Hábitos</h2>
                    <div class="habit-tag">Total: 0</div>
                </div>
                <div class="habits-list" id="allHabitsList">
                    <!-- Todos os hábitos serão renderizados aqui -->
                </div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="statsTab" class="tab-content" style="display: none;">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-calendar-check" style="color: var(--primary); font-size: 24px;"></i>
                    <div class="stat-value" id="totalHabits">0</div>
                    <div class="stat-label">Hábitos Totais</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-fire" style="color: var(--warning); font-size: 24px;"></i>
                    <div class="stat-value" id="currentStreak">0 de 0</div>
                    <div class="stat-label">Sequência Atual</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line" style="color: var(--success); font-size: 24px;"></i>
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">Taxa de Sucesso</div>
                </div>
            </div>

            <!-- Heatmap -->
            <div class="heatmap-container">
                <h2>Histórico de Atividade</h2>
                <div class="heatmap-grid" id="heatmapGrid">
                    <!-- Heatmap será renderizado aqui -->
                </div>
                <div class="heatmap-legend">
                    <span>Menos</span>
                    <div style="display: flex; gap: 3px;">
                        <div class="heatmap-day" style="background: #E8E8E8;"></div>
                        <div class="heatmap-day" style="background: #9BE9A8;"></div>
                        <div class="heatmap-day" style="background: #40C463;"></div>
                        <div class="heatmap-day" style="background: #30A14E;"></div>
                        <div class="heatmap-day" style="background: #216E39;"></div>
                    </div>
                    <span>Mais</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="habitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Hábito</h3>
                <button class="btn-icon" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="habitForm">
                <div class="form-group">
                    <label for="habitName">Nome do Hábito</label>
                    <input type="text" id="habitName" class="form-control" placeholder="Ex: Beber água" required>
                </div>
                <div class="form-group">
                    <label for="habitDescription">Descrição</label>
                    <input type="text" id="habitDescription" class="form-control" placeholder="Ex: 2 litros por dia">
                </div>
                <div class="form-group">
                    <label for="habitFrequency">Frequência</label>
                    <select id="habitFrequency" class="form-control" required>
                        <option value="daily">Diário</option>
                        <option value="weekdays">Dias úteis</option>
                        <option value="weekly">Semanal</option>
                        <option value="monthly">Mensal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="habitTime">Período do Dia</label>
                    <select id="habitTime" class="form-control" required>
                        <option value="morning">Manhã</option>
                        <option value="afternoon">Tarde</option>
                        <option value="evening">Noite</option>
                        <option value="anytime">Qualquer hora</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-check"></i> Criar Hábito
                </button>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

   <script>
    // Dados da Aplicação - VÊM DO data.json
    let habits = [];
    let completions = {};
    let currentDataFile = null; // Guarda referência do arquivo carregado

    // Inicialização
    document.addEventListener('DOMContentLoaded', async function() {
        await loadDataFromJson();
        renderTodayHabits();
        renderAllHabits();
        renderHeatmap();
        updateStats();
        setupFileHandlers();
    });

    // ================ CONFIGURAR HANDLERS DE ARQUIVO ================
    function setupFileHandlers() {
        const controls = document.querySelector('.header .controls');
        
        // Botão para carregar data.json
        const loadBtn = document.createElement('button');
        loadBtn.className = 'btn btn-secondary';
        loadBtn.innerHTML = '<i class="fas fa-folder-open"></i> Abrir data.json';
        loadBtn.onclick = () => document.getElementById('jsonFileInput').click();
        loadBtn.title = 'Abrir arquivo data.json existente';
        
        // Botão para salvar alterações
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar';
        saveBtn.onclick = saveDataToFile;
        saveBtn.title = 'Salvar alterações em data.json';
        saveBtn.style.background = '#2196F3';
        
        // Input file oculto
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'jsonFileInput';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        fileInput.onchange = handleFileSelect;
        
        // Status do arquivo
        const fileStatus = document.createElement('div');
        fileStatus.id = 'fileStatus';
        fileStatus.style.marginLeft = '10px';
        fileStatus.style.color = '#666';
        fileStatus.style.fontSize = '12px';
        fileStatus.style.alignSelf = 'center';
        fileStatus.innerHTML = 'Nenhum arquivo carregado';
        
        // Adicionar elementos
        controls.appendChild(loadBtn);
        controls.appendChild(saveBtn);
        document.body.appendChild(fileInput);
        
        // Adicionar status após os botões
        setTimeout(() => {
            controls.parentNode.insertBefore(fileStatus, controls.nextSibling);
        }, 100);
        
        // Tentar carregar automaticamente data.json
        autoLoadDataJson();
    }

    // ================ CARREGAR data.json AUTOMATICAMENTE ================
    async function autoLoadDataJson() {
        try {
            const response = await fetch('data.json');
            if (response.ok) {
                const data = await response.json();
                habits = data.habits || [];
                completions = data.completions || {};
                updateFileStatus('data.json carregado', 'success');
                showToast('Dados carregados de data.json');
            }
        } catch (error) {
            // Não faz nada se não encontrar
            console.log('data.json não encontrado na raiz');
        }
    }

    // ================ MANIPULAR SELEÇÃO DE ARQUIVO ================
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            // Validar estrutura
            if (!data.habits) {
                throw new Error('Arquivo inválido: falta propriedade "habits"');
            }
            
            habits = data.habits || [];
            completions = data.completions || {};
            currentDataFile = file;
            
            updateFileStatus(file.name, 'success');
            showToast(`Arquivo "${file.name}" carregado com sucesso!`);
            
            renderTodayHabits();
            renderAllHabits();
            updateStats();
            
        } catch (error) {
            console.error('Erro ao carregar arquivo:', error);
            updateFileStatus('Erro: arquivo inválido', 'error');
            showToast('Erro ao carregar arquivo JSON');
        }
    }

    // ================ SALVAR DADOS NO ARQUIVO ================
    function saveDataToFile() {
        if (!currentDataFile && !confirm('Nenhum arquivo carregado. Deseja criar um novo data.json?')) {
            return;
        }
        
        const data = {
            habits: habits,
            completions: completions,
            lastUpdated: new Date().toISOString(),
            version: "1.0"
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        
        // Criar nome do arquivo
        let fileName = 'data.json';
        if (currentDataFile) {
            fileName = currentDataFile.name;
        }
        
        // Criar link para download
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = fileName;
        
        // Adicionar e clicar no link
        document.body.appendChild(link);
        link.click();
        
        // Limpar
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 100);
        
        updateFileStatus(`${fileName} salvo`, 'success');
        showToast(`Arquivo "${fileName}" pronto para salvar!`);
    }

    // ================ ATUALIZAR STATUS DO ARQUIVO ================
    function updateFileStatus(message, type = 'info') {
        const statusEl = document.getElementById('fileStatus');
        if (!statusEl) return;
        
        const colors = {
            success: '#4CAF50',
            error: '#F44336',
            info: '#666'
        };
        
        statusEl.innerHTML = `<i class="fas fa-file${type === 'success' ? '-check' : type === 'error' ? '-exclamation' : ''}"></i> ${message}`;
        statusEl.style.color = colors[type] || colors.info;
    }

    // ================ FUNÇÕES DE RENDERIZAÇÃO (MANTIDAS) ================
    function renderTodayHabits() {
        const todayList = document.getElementById('todayHabitsList');
        const today = new Date().toLocaleDateString('pt-BR');
        
        let html = '';
        let completedCount = 0;
        let totalToday = 0;

        habits.forEach(habit => {
            if (shouldShowToday(habit)) {
                totalToday++;
                const isCompleted = habit.completedToday;
                if (isCompleted) completedCount++;
                
                html += `
                    <div class="habit-item">
                        <div class="habit-info">
                            <div class="habit-title">
                                <i class="fas fa-${getHabitIcon(habit.name)}"></i>
                                ${habit.name}
                                ${isCompleted ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : ''}
                            </div>
                            <div class="habit-description">${habit.description}</div>
                            <div class="habit-tag">
                                <i class="fas fa-fire"></i> ${habit.streak} dias
                            </div>
                        </div>
                        <div class="habit-actions">
                            <button class="btn-icon btn-complete ${isCompleted ? 'active' : ''}" 
                                    onclick="toggleHabit(${habit.id})">
                                <i class="fas ${isCompleted ? 'fa-check' : 'fa-plus'}"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        if (totalToday === 0) {
            html = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <h3>Nenhum hábito para hoje!</h3>
                    <p>Que tal criar um novo hábito ou descansar um pouco?</p>
                </div>
            `;
        }

        todayList.innerHTML = html;
        
        const headerTag = document.querySelector('.habits-section .habit-tag');
        if (headerTag) {
            headerTag.textContent = `${completedCount} de ${totalToday} concluídos`;
        }
    }

    function renderAllHabits() {
        const allList = document.getElementById('allHabitsList');
        
        if (habits.length === 0) {
            allList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-plus-circle"></i>
                    <h3>Nenhum hábito ainda</h3>
                    <p>Crie seu primeiro hábito clicando no botão "+"</p>
                </div>
            `;
            return;
        }

        let html = '';
        habits.forEach(habit => {
            html += `
                <div class="habit-item">
                    <div class="habit-info">
                        <div class="habit-title">
                            <i class="fas fa-${getHabitIcon(habit.name)}"></i>
                            ${habit.name}
                        </div>
                        <div class="habit-description">${habit.description}</div>
                        <div class="habit-tag">
                            <i class="fas fa-${getFrequencyIcon(habit.frequency)}"></i>
                            ${getFrequencyText(habit.frequency)}
                            <span style="margin-left: 8px;">
                                <i class="fas fa-fire"></i> ${habit.streak} dias
                            </span>
                        </div>
                    </div>
                    <div class="habit-actions">
                        <button class="btn-icon" onclick="editHabit(${habit.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="deleteHabit(${habit.id})" 
                                style="color: var(--danger);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        allList.innerHTML = html;
        
        const headerTag = document.querySelector('#allTab .habit-tag');
        if (headerTag) {
            headerTag.textContent = `Total: ${habits.length}`;
        }
    }

    function renderHeatmap() {
        const grid = document.getElementById('heatmapGrid');
        let html = '';
        
        const today = new Date();
        const startDate = new Date(today);
        startDate.setDate(startDate.getDate() - 364);
        
        let currentDate = new Date(startDate);
        
        for (let i = 0; i < 365; i++) {
            const dateStr = currentDate.toISOString().split('T')[0];
            const level = getActivityLevel(dateStr);
            const color = getHeatmapColor(level);
            
            html += `<div class="heatmap-day" style="background: ${color};" 
                     title="${formatDate(currentDate)}: Nível ${level}"></div>`;
            
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        grid.innerHTML = html;
    }

    // ================ FUNÇÕES UTILITÁRIAS ================
    function getHabitIcon(name) {
        const icons = {
            'água': 'tint', 'exercitar': 'dumbbell', 'meditar': 'spa',
            'ler': 'book', 'planejar': 'tasks', 'dormir': 'moon',
            'estudar': 'graduation-cap'
        };
        
        for (const [key, icon] of Object.entries(icons)) {
            if (name.toLowerCase().includes(key)) return icon;
        }
        return 'check-circle';
    }

    function getFrequencyIcon(freq) {
        const icons = {
            'daily': 'calendar-day', 'weekdays': 'briefcase',
            'weekly': 'calendar-week', 'monthly': 'calendar-alt'
        };
        return icons[freq] || 'calendar';
    }

    function getFrequencyText(freq) {
        const texts = {
            'daily': 'Diário', 'weekdays': 'Dias úteis',
            'weekly': 'Semanal', 'monthly': 'Mensal'
        };
        return texts[freq] || freq;
    }

    function shouldShowToday(habit) {
        const today = new Date();
        const day = today.getDay();
        
        switch(habit.frequency) {
            case 'daily': return true;
            case 'weekdays': return day >= 1 && day <= 5;
            case 'weekly': return day === 1;
            case 'monthly': return today.getDate() === 1;
            default: return true;
        }
    }

    function getActivityLevel(dateStr) {
        let level = 0;
        habits.forEach(habit => {
            if (habit.createdAt && habit.createdAt.includes(dateStr.substring(0, 10))) {
                level += habit.completedToday ? 1 : 0.5;
            }
        });
        return Math.min(4, Math.floor(level));
    }

    function getHeatmapColor(level) {
        const colors = ['#E8E8E8', '#9BE9A8', '#40C463', '#30A14E', '#216E39'];
        return colors[level] || colors[0];
    }

    function formatDate(date) {
        return date.toLocaleDateString('pt-BR');
    }

    // ================ FUNÇÕES DE INTERAÇÃO ================
    function openModal() {
        document.getElementById('habitModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('habitModal').classList.remove('active');
        document.getElementById('habitForm').reset();
    }

    // Form Handler
    document.getElementById('habitForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newHabit = {
            id: Date.now(),
            name: document.getElementById('habitName').value,
            description: document.getElementById('habitDescription').value,
            frequency: document.getElementById('habitFrequency').value,
            time: document.getElementById('habitTime').value,
            completedToday: false,
            streak: 0,
            createdAt: new Date().toISOString()
        };
        
        habits.push(newHabit);
        renderTodayHabits();
        renderAllHabits();
        updateStats();
        closeModal();
        showToast('Hábito criado com sucesso!');
        
        // Marcar que há alterações não salvas
        updateFileStatus('Alterações não salvas', 'error');
    });

    // Habit Actions
    function toggleHabit(id) {
        const habit = habits.find(h => h.id === id);
        if (!habit) return;
        
        habit.completedToday = !habit.completedToday;
        
        if (habit.completedToday) {
            habit.streak++;
            showToast(`Parabéns! Você completou "${habit.name}"`);
            createConfetti();
        } else {
            habit.streak = Math.max(0, habit.streak - 1);
        }
        
        renderTodayHabits();
        updateStats();
        updateFileStatus('Alterações não salvas', 'error');
    }

    function deleteHabit(id) {
        if (confirm('Tem certeza que deseja excluir este hábito?')) {
            habits = habits.filter(h => h.id !== id);
            renderTodayHabits();
            renderAllHabits();
            updateStats();
            showToast('Hábito excluído');
            updateFileStatus('Alterações não salvas', 'error');
        }
    }

    function editHabit(id) {
        const habit = habits.find(h => h.id === id);
        if (!habit) return;
        
        document.getElementById('habitName').value = habit.name;
        document.getElementById('habitDescription').value = habit.description;
        document.getElementById('habitFrequency').value = habit.frequency;
        document.getElementById('habitTime').value = habit.time;
        
        const form = document.getElementById('habitForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
        
        form.removeEventListener('submit', arguments.callee);
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            habit.name = document.getElementById('habitName').value;
            habit.description = document.getElementById('habitDescription').value;
            habit.frequency = document.getElementById('habitFrequency').value;
            habit.time = document.getElementById('habitTime').value;
            
            renderTodayHabits();
            renderAllHabits();
            closeModal();
            showToast('Hábito atualizado!');
            updateFileStatus('Alterações não salvas', 'error');
            
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Criar Hábito';
            form.reset();
        }, {once: true});
        
        openModal();
    }

    // Tabs
    function switchTab(tabName) {
        document.getElementById('todayTab').style.display = 'none';
        document.getElementById('allTab').style.display = 'none';
        document.getElementById('statsTab').style.display = 'none';
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(tabName + 'Tab').style.display = 'block';
        event.target.classList.add('active');
    }

    // Stats
    function updateStats() {
        const totalHabits = habits.length;
        const completedToday = habits.filter(h => h.completedToday).length;
        const totalCompletions = habits.reduce((sum, h) => sum + h.streak, 0);
        
        let successRate = 0;
        if (totalHabits > 0) {
            const avgStreak = totalCompletions / totalHabits;
            successRate = Math.min(100, Math.round((avgStreak / 30) * 100));
        }
        
        document.getElementById('totalHabits').textContent = totalHabits;
        document.getElementById('currentStreak').textContent = `${completedToday} de ${habits.length} hoje`;
        document.getElementById('successRate').textContent = `${successRate}%`;
    }

    // Toast
    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        toastMessage.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Confetti Effect
    function createConfetti() {
        const colors = ['#00B22D', '#FF6B00', '#FF9500', '#FFC107'];
        
        for (let i = 0; i < 20; i++) {
            const confetti = document.createElement('div');
            confetti.style.cssText = `
                position: fixed;
                width: 10px;
                height: 10px;
                background: ${colors[Math.floor(Math.random() * colors.length)]};
                border-radius: 50%;
                top: 90%;
                left: ${50 + Math.random() * 10 - 5}%;
                z-index: 10000;
                pointer-events: none;
                animation: confetti 1s ease-out forwards;
            `;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => {
                confetti.remove();
            }, 1000);
        }
        
        if (!document.querySelector('#confetti-animation')) {
            const style = document.createElement('style');
            style.id = 'confetti-animation';
            style.textContent = `
                @keyframes confetti {
                    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                    100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Fechar modal
    document.getElementById('habitModal').addEventListener('click', function(e) {
        if (e.target.id === 'habitModal') {
            closeModal();
        }
    });

    // REMOVER função loadDataFromJson antiga
    // Manter apenas as novas funções de arquivo
</script>
</body>
</html>